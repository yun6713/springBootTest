通用-获取账期
SELECT 
  CUR_DATE 
FROM 
  HR_DSS.SYS_MODULE_DATE 
where 
  MODULE_ID = 'homePage'
通用-获取父级地域
SELECT 
  T.org_ID AS "id", 
  T.NAME AS "text", 
  T.PARENT_ID AS "parentId", 
  (
    CASE WHEN EXISTS (
      SELECT 
        1 
      FROM 
        dm_code.code_org A 
      WHERE 
        A.PARENT_ID = T.org_ID
    ) THEN 0 ELSE 1 END
  ) "leaf" 
FROM 
  dm_code.code_org T 
WHERE 
  T.org_ID = '018' 
ORDER BY 
  T.idx_no
通用-获取地域层级
select 
  GRADE 
from 
  DM_CODE.CODE_ORG 
where 
  ORG_ID = '188'
通用-获取岗位
select 
  GW_CODE VAL, 
  GW_NAME NAME 
from 
  DM_CODE.CODE_GW 
WHERE 
  line_code = '1' 
order by 
  gw_idx
通用-获取用工类型
select 
  EMP_TYPE VAL, 
  CODE_DESC NAME 
from 
  DM_CODE.CODE_EMP_TYPE


首页-组织结构
select 
  type.CODE_DESC NAME, 
  nvl(temp.NUMS, 0) VALUE, 
  nvl(
    decode(
      sum(temp.NUMS) over(), 
      0, 
      0, 
      round(
        temp.NUMS * 100 /(
          sum(temp.NUMS) over()
        ), 
        2
      )
    ), 
    0
  ) PER, 
  nvl(temp.NUMS - temp.NUM1S, 0) HB_INCR, 
  nvl(temp.NUMS - temp.NUM2S, 0) TB_INCR 
from 
  DM_CODE.CODE_ORG_TYPE type 
  left join (
    select 
      hr.ORG_TYPE, 
      sum(
        nvl(hr.EMP_NUM, 0)
      ) NUMS, 
      sum(
        nvl(hr.EMP_NUM1, 0)
      ) NUM1S, 
      sum(
        nvl(hr.EMP_NUM2, 0)
      ) NUM2S 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_HOME_COMP_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID = '201910' 
    group by 
      hr.ORG_TYPE
  ) temp on temp.ORG_TYPE = type.ORG_TYPE 
order by 
  type.IDX_NO
首页-划小单元
select 
  type.CODE_DESC NAME, 
  nvl(temp.NUMS, 0) VALUE, 
  nvl(
    decode(
      sum(temp.NUMS) over(), 
      0, 
      0, 
      round(
        temp.NUMS * 100 /(
          sum(temp.NUMS) over()
        ), 
        2
      )
    ), 
    0
  ) PER, 
  nvl(temp.NUMS - temp.NUM1S, 0) HB_INCR, 
  nvl(temp.NUMS - temp.NUM2S, 0) TB_INCR 
from 
  DM_CODE.CODE_SALE_TYPE type 
  left join (
    select 
      hr.SALE_TYPE, 
      sum(
        nvl(hr.EMP_NUM, 0)
      ) NUMS, 
      sum(
        nvl(hr.EMP_NUM1, 0)
      ) NUM1S, 
      sum(
        nvl(hr.EMP_NUM2, 0)
      ) NUM2S 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_HOME_COMP_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID = '201910' 
    group by 
      hr.SALE_TYPE
  ) temp on temp.SALE_TYPE = type.SALE_TYPE 
order by 
  type.IDX_NO
首页-专业结构
select 
  type.CODE_DESC NAME, 
  nvl(temp.NUMS, 0) VALUE, 
  nvl(
    decode(
      sum(temp.NUMS) over(), 
      0, 
      0, 
      round(
        temp.NUMS * 100 /(
          sum(temp.NUMS) over()
        ), 
        2
      )
    ), 
    0
  ) PER, 
  nvl(temp.NUMS - temp.NUM1S, 0) HB_INCR, 
  nvl(temp.NUMS - temp.NUM2S, 0) TB_INCR 
from 
  DM_CODE.CODE_LINE_TYPE type 
  left join (
    select 
      hr.LINE_TYPE, 
      sum(
        nvl(hr.EMP_NUM, 0)
      ) NUMS, 
      sum(
        nvl(hr.EMP_NUM1, 0)
      ) NUM1S, 
      sum(
        nvl(hr.EMP_NUM2, 0)
      ) NUM2S 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_HOME_COMP_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID = '201910' 
    group by 
      hr.LINE_TYPE
  ) temp on temp.LINE_TYPE = type.LINE_TYPE 
order by 
  type.IDX_NO
首页-全员透视
select 
  month.MONTH MONTH, 
  nvl(temp.NUM, 0) NUM, 
  nvl(temp.NUM1, 0) NUM1, 
  nvl(temp.NUM2, 0) NUM2, 
  nvl(temp.NUM3, 0) NUM3 
from 
  (
    SELECT 
      TO_CHAR(
        ADD_MONTHS(
          TO_DATE('201910', 'yyyyMM'), 
          - ROWNUM + 1
        ), 
        'yyyyMM'
      ) MONTH 
    FROM 
      dual CONNECT BY ROWNUM <= 12
  ) month 
  left join (
    select 
      hr.MONTH_ID, 
      sum(
        nvl(hr.ZC_NUM, 0)
      ) NUM, 
      sum(
        nvl(hr.LOGIN_NUM, 0)
      ) NUM1, 
      sum(
        nvl(hr.LOGIN_NUM1, 0)
      ) NUM2, 
      sum(
        nvl(hr.LOGIN_NUM2, 0)
      ) NUM3 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_HOME_ACTIVE_MON hr on hr.SALE_NO = org.ORG_ID 
    group by 
      hr.MONTH_ID
  ) temp on month.MONTH = temp.MONTH_ID 
order by 
  month.MONTH
首页-全员透视-子表格1
select 
  org.AREA NAME, 
  temp.AREA ORGID, 
  nvl(temp.NUM1, 0) NUM1, 
  nvl(temp.NUM2, 0) NUM2 
from 
  (
    select 
      ORG_ID, 
      IDX_NO, 
      ORGRANK_NAME AREA 
    from 
      DM_CODE.CODE_ORG 
    where 
      PARENT_ID = '188'
  ) org 
  left join (
    select 
      hr.CITY_NO ?AREA, 
      sum(
        nvl(LOGIN_NUM1, 0)
      ) NUM1, 
      sum(
        nvl(NLOGIN_NUM1, 0)
      ) NUM2 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_HOME_ACTIVE_ORG_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID = '201910' 
    group by 
      hr.CITY_NO
  ) temp on org.ORG_ID = temp.AREA 
order by 
  IDX_NO
首页-全员透视-子表格2
select 
  hr.MONTH_ID MONTH, 
  code.AREA_NAME AREA, 
  code.CITY_NAME CITY, 
  code.ORG_NAME ORG, 
  code.ORG_NO ORGNO, 
  code.SALE_NAME SALE, 
  code.SALE_NO SALENO, 
  hr.EMP_NAME NAME, 
  hr.EMP_CODE VAL 
from 
  (
    select 
      ORG_ID, 
      ORGRANK_NAME AREA 
    from 
      DM_CODE.CODE_ORG 
    where 
      ORGRANK like (
        select 
          case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORG_ID = '188'
      )
  ) org 
  left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
  left join DM_CODE.CODE_ORG_SALE code on hr.ORG_NO = code.ORG_NO 
where 
  hr.MONTH_ID = '201910' 
  and hr.IS_ACTIVE2 = 0
首页-人员迁移
select 
  code.CODE_DESC NAME, 
  nvl(temp.VAL, 0) VAL 
from 
  DM_CODE.CODE_FLOW_TYPE code 
  left join (
    select 
      hr.FLOW_TYPE, 
      sum(
        nvl(hr.FLOW_TOTAL, 0)
      ) VAL 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_HOME_FLOW_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID = '201910' 
    group by 
      hr.FLOW_TYPE
  ) temp on temp.FLOW_TYPE = code.FLOW_TYPE 
order by 
  code.IDX_NO


月透视-默认对标地域
select 
  NAME, 
  VAL 
from 
  (
    select 
      NAME, 
      ORG_ID VAL 
    from 
      DM_CODE.CODE_ORG 
    where 
      PARENT_ID = '018' 
      or PARENT_ID =(
        select 
          PARENT_ID 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORG_ID = '018' 
          and ROWNUM = 1
      ) 
    order by 
      grade desc, 
      IDX_NO
  ) 
where 
  ROWNUM <= 4
月透视-平均产能
select 
  month.MONTH NAME, 
  nvl(temp.VAL, 0) VAL 
from 
  (
    SELECT 
      TO_CHAR(
        ADD_MONTHS(
          TO_DATE('201910', 'yyyyMM'), 
          - ROWNUM + 1
        ), 
        'yyyyMM'
      ) MONTH 
    FROM 
      dual CONNECT BY ROWNUM <= 12
  ) month 
  left join (
    select 
      hr.MONTH_ID, 
      round(
        avg(
          nvl(hr.CAP, 0)
        ), 
        2
      ) VAL 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.ZG_GW = '101' 
      and hr.EMP_TYPE = '0' 
      and hr.LINE_TYPE = '1' 
    group by 
      hr.MONTH_ID
  ) temp on month.MONTH = temp.MONTH_ID 
order by 
  NAME
月透视-关键指标趋势
select 
  k.CODE_DESC LGD, 
  k.MONTH NAME, 
  nvl(temp.VAL, 0) VAL 
from 
  (
    select 
      * 
    from 
      (
        SELECT 
          TO_CHAR(
            ADD_MONTHS(
              TO_DATE('201910', 'yyyyMM'), 
              - ROWNUM + 1
            ), 
            'yyyyMM'
          ) MONTH 
        FROM 
          dual CONNECT BY ROWNUM <= 12
      ) month, 
      (
        select 
          * 
        from 
          DM_CODE.CODE_KPI_CODE 
        where 
          GW_CODE = '101'
      ) code
  ) k 
  left join (
    select 
      t1.MONTH_ID, 
      t1.KPI_CODE, 
      round(
        avg(
          nvl(t1.KPI_VALUE, 0)
        ), 
        2
      ) VAL 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_EMPLOYEE_KPI_MON t1 on org.ORG_ID = t1.SALE_NO 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on t1.EMP_CODE = hr.EMP_CODE 
    where 
      t1.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.ZG_GW = '101' 
      and hr.EMP_TYPE = '0' 
      and hr.LINE_TYPE = '1' 
    group by 
      t1.MONTH_ID, 
      t1.KPI_CODE
  ) temp on k.MONTH = temp.MONTH_ID 
  and k.KPI_CODE = temp.KPI_CODE 
order by 
  k.IDX_NO, 
  k.MONTH
月透视-低产能分析
select 
  month.MONTH NAME, 
  nvl(temp.VAL1, 0) VAL1, 
  nvl(temp.VAL2, 0) VAL2 
from 
  (
    SELECT 
      TO_CHAR(
        ADD_MONTHS(
          TO_DATE('201910', 'yyyyMM'), 
          - ROWNUM + 1
        ), 
        'yyyyMM'
      ) MONTH 
    FROM 
      dual CONNECT BY ROWNUM <= 12
  ) month 
  left join (
    select 
      hr.MONTH_ID, 
      sum(
        nvl(hr.JX_FEE, 0)
      ) VAL1, 
      count(1) VAL2 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.ZG_GW = '101' 
      and hr.EMP_TYPE = '0' 
      and hr.LINE_TYPE = '1' 
      and hr.IS_LOW = 1 
    group by 
      hr.MONTH_ID
  ) temp on month.MONTH = temp.MONTH_ID 
order by 
  month.MONTH
月透视-原因分析
select 
  code.CODE_DESC KPI, 
  code.IDX_NO, 
  nvl(temp.VAL1, 0) VAL1, 
  nvl(temp.VAL2, 0) VAL2 
from 
  DM_CODE.CODE_KPI_CODE code 
  left join (
    select 
      t1.KPI_CODE, 
      round(
        avg(t1.KPI_VALUE), 
        2
      )|| '' VAL1, 
      round(
        avg(t1.KPI_AVG2), 
        2
      )|| '' VAL2 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_EMPLOYEE_KPI_MON t1 on org.ORG_ID = t1.SALE_NO 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on t1.EMP_CODE = hr.EMP_CODE 
    where 
      t1.MONTH_ID = '201910' 
      and hr.ZG_GW = '101' 
      and hr.EMP_TYPE = '0' 
      and hr.LINE_TYPE = '1' 
    group by 
      t1.KPI_CODE
  ) temp on temp.KPI_CODE = code.KPI_CODE 
where 
  code.gw_code = '101' 
order by 
  code.IDX_NO
月透视-获取对标地域，同级前三个
select 
  NAME, 
  ORG_ID VAL 
from 
  DM_CODE.CODE_ORG 
where 
  PARENT_ID =(
    select 
      PARENT_ID 
    from 
      DM_CODE.CODE_ORG 
    where 
      ORG_ID = '188'
  ) 
  and ORG_ID != '188' 
  and ROWNUM < 4 
order by 
  IDX_NO
月透视-产能同级对标
select 
  cities.NAME, 
  nvl(temp.VAL1, 0) VAL1, 
  nvl(temp.VAL2, 0) VAL2, 
  nvl(temp.VAL3, 0) VAL3, 
  nvl(temp.VAL4, 0) VAL4 
from 
  (
    select 
      ORG_ID, 
      NAME, 
      IDX_NO 
    from 
      DM_CODE.CODE_org 
    where 
      ORG_ID in ('188', '720')
  ) cities 
  left join (
    select 
      t1.AREA_NO AREA, 
      round(
        avg(
          decode(code.IDX_NO, 1, t1.KPI_VALUE, 0)
        ), 
        2
      )|| '' VAL1, 
      round(
        avg(
          decode(code.IDX_NO, 2, t1.KPI_VALUE, 0)
        ), 
        2
      )|| '' VAL2, 
      round(
        avg(
          decode(code.IDX_NO, 3, t1.KPI_VALUE, 0)
        ), 
        2
      )|| '' VAL3, 
      round(
        avg(
          decode(code.IDX_NO, 4, t1.KPI_VALUE, 0)
        ), 
        2
      )|| '' VAL4 
    from 
      DM_CODE.CODE_ORG org 
      left join HR_DM.HR_DM_EMPLOYEE_KPI_MON t1 on org.ORG_ID = t1.SALE_NO 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on t1.EMP_CODE = hr.EMP_CODE 
      left join DM_CODE.CODE_KPI_CODE code on t1.KPI_CODE = code.KPI_CODE 
    where 
      t1.MONTH_ID = '201910' 
      and hr.ZG_GW = '101' 
      and hr.EMP_TYPE = '0' 
      and hr.LINE_TYPE = '1' 
      and t1.AREA_NO in ('188', '720') 
    group by 
      t1.AREA_NO
  ) temp on cities.ORG_ID = temp.AREA 
order by 
  cities.IDX_NO
月透视-原因分析
select 
  code.CODE_DESC KPI, 
  code.IDX_NO, 
  nvl(temp.VAL1, 0) VAL1, 
  nvl(temp.VAL2, 0) VAL2 
from 
  DM_CODE.CODE_KPI_CODE code 
  left join (
    select 
      t1.KPI_CODE, 
      round(
        avg(t1.KPI_VALUE), 
        2
      )|| '' VAL1, 
      round(
        avg(t1.KPI_AVG2), 
        2
      )|| '' VAL2 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_EMPLOYEE_KPI_MON t1 on org.ORG_ID = t1.SALE_NO 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on t1.EMP_CODE = hr.EMP_CODE 
    where 
      t1.MONTH_ID = '201910' 
      and hr.ZG_GW = '101' 
      and hr.EMP_TYPE = '0' 
      and hr.LINE_TYPE = '1' 
    group by 
      t1.KPI_CODE
  ) temp on temp.KPI_CODE = code.KPI_CODE 
where 
  code.gw_code = '101' 
order by 
  code.IDX_NO
月透视-产能薪酬
select 
  nvl(hr.CAP, 0)|| '' XAXIS, 
  nvl(hr.YF_FEE, 0)|| '' VAL, 
  round(
    avg(
      nvl(hr.CAP, 0)
    ) over(), 
    2
  ) AVGX, 
  round(
    avg(
      nvl(hr.YF_FEE, 0)
    ) over(), 
    2
  ) AVGY 
from 
  (
    select 
      ORG_ID, 
      ORGRANK_NAME AREA 
    from 
      DM_CODE.CODE_ORG 
    where 
      ORGRANK like (
        select 
          case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORG_ID = '188'
      )
  ) org 
  left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
where 
  hr.MONTH_ID = '201910' 
  and hr.ZG_GW = '101' 
  and hr.EMP_TYPE = '0' 
  and hr.LINE_TYPE = '1' 
order by 
  hr.CAP, 
  hr.YF_FEE
月透视-产能薪酬百分比
select 
  month.MONTH NAME, 
  nvl(temp.VAL1, 0)* 100 VAL1, 
  nvl(temp.VAL2, 0)* 100 VAL2, 
  nvl(temp.VAL3, 0)* 100 VAL3, 
  nvl(temp.VAL4, 0)* 100 VAL4 
from 
  (
    SELECT 
      TO_CHAR(
        ADD_MONTHS(
          TO_DATE('201910', 'yyyyMM'), 
          - ROWNUM + 1
        ), 
        'yyyyMM'
      ) MONTH 
    FROM 
      dual CONNECT BY ROWNUM <= 12
  ) month 
  left join (
    select 
      t1.MONTH_ID, 
      round(
        sum(
          case when t2.CAP_RANK > (0.7 * t1.SUM) then t2.CAP / t1.CAPS else 0 end
        ), 
        4
      ) VAL1, 
      round(
        sum(
          case when t2.FEE_RANK > (0.7 * t1.SUM) then t2.YF_FEE / t1.FEES else 0 end
        ), 
        4
      ) VAL2, 
      round(
        sum(
          case when t2.CAP_RANK < (0.3 * t1.SUM) then t2.CAP / t1.CAPS else 0 end
        ), 
        4
      ) VAL3, 
      round(
        sum(
          case when t2.FEE_RANK < (0.3 * t1.SUM) then t2.YF_FEE / t1.FEES else 0 end
        ), 
        4
      ) VAL4 
    from 
      (
        select 
          hr.MONTH_ID, 
          count(1) SUM, 
          sum(
            nvl(hr.CAP, 0)
          ) CAPS, 
          sum(
            nvl(hr.YF_FEE, 0)
          ) FEES 
        from 
          (
            select 
              ORG_ID, 
              ORGRANK_NAME AREA 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORGRANK like (
                select 
                  case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
                from 
                  DM_CODE.CODE_ORG 
                where 
                  ORG_ID = '188'
              )
          ) org 
          left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
        where 
          hr.MONTH_ID between to_char(
            add_months(
              TO_date('201910', 'yyyyMM'), 
              -12
            ), 
            'yyyyMM'
          ) 
          and '201910' 
          and hr.ZG_GW = '101' 
          and hr.EMP_TYPE = '0' 
          and hr.LINE_TYPE = '1' 
        group by 
          hr.MONTH_ID
      ) t1 
      left join (
        select 
          hr.MONTH_ID, 
          rank() over(
            partition by hr.MONTH_ID 
            order by 
              hr.CAP
          ) CAP_RANK, 
          hr.CAP, 
          rank() over(
            partition by hr.MONTH_ID 
            order by 
              hr.YF_FEE
          ) FEE_RANK, 
          hr.YF_FEE 
        from 
          (
            select 
              ORG_ID, 
              ORGRANK_NAME AREA 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORGRANK like (
                select 
                  case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
                from 
                  DM_CODE.CODE_ORG 
                where 
                  ORG_ID = '188'
              )
          ) org 
          left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
        where 
          hr.MONTH_ID between to_char(
            add_months(
              TO_date('201910', 'yyyyMM'), 
              -12
            ), 
            'yyyyMM'
          ) 
          and '201910' 
          and hr.ZG_GW = '101' 
          and hr.EMP_TYPE = '0' 
          and hr.LINE_TYPE = '1'
      ) t2 on t1.MONTH_ID = t2.MONTH_ID 
    group by 
      t1.MONTH_ID
  ) temp on month.MONTH = temp.MONTH_ID 
order by 
  NAME
月透视-岗位效率排行榜
select 
  info.EMP_CODE CODE, 
  info.EMP_NAME NAME, 
  info.SALE_NO SALENO, 
  org.AREA CITY, 
  gw.GW_NAME ZGGW, 
  type.CODE_DESC TYPE, 
  kpi.RANK1 RANK1, 
  kpi.SCORE1 VAL1, 
  kpi.RANK2 RANK2, 
  kpi.SCORE2 VAL2, 
  kpi.RANK3 RANK3, 
  kpi.SCORE3 VAL3, 
  info.A_NO RANK4, 
  info.A_NO1 RANK5, 
  nvl(info.CAP, 0) VAL4, 
  round(
    nvl(info.CAP, 0)* 100 / sum(
      nvl(info.CAP, 0)
    ) over(), 
    2
  ) PER4, 
  nvl(info.YF_FEE, 0) VAL5, 
  round(
    nvl(info.YF_FEE, 0)* 100 / sum(
      nvl(info.YF_FEE, 0)
    ) over(), 
    2
  ) PER5 
from 
  (
    select 
      ORG_ID, 
      ORGRANK_NAME AREA 
    from 
      DM_CODE.CODE_ORG 
    where 
      ORGRANK like (
        select 
          case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORG_ID = '188'
      )
  ) org 
  left join HR_DM.HR_DM_EMPLOYEE_INFO_MON info on org.ORG_ID = info.SALE_NO 
  left join DM_CODE.CODE_GW gw on info.ZG_GW = gw.GW_CODE 
  left join DM_CODE.CODE_EMP_TYPE type on info.EMP_TYPE = type.EMP_TYPE 
  left join (
    select 
      t1.EMP_CODE, 
      rank() over(
        order by 
          t1.SCORE1 desc
      ) RANK1, 
      t1.SCORE1, 
      rank() over(
        order by 
          t1.SCORE2 desc
      ) RANK2, 
      t1.SCORE2, 
      rank() over(
        order by 
          t1.SCORE3 desc
      ) RANK3, 
      t1.SCORE3 
    from 
      (
        select 
          t.EMP_CODE, 
          sum(
            decode(
              code.IDX_NO, 
              1, 
              nvl(t.KPI_VALUE, 0), 
              0
            )
          ) SCORE1, 
          sum(
            decode(
              code.IDX_NO, 
              2, 
              nvl(t.KPI_VALUE, 0), 
              0
            )
          ) SCORE2, 
          sum(
            decode(
              code.IDX_NO, 
              3, 
              nvl(t.KPI_VALUE, 0), 
              0
            )
          ) SCORE3 
        from 
          (
            select 
              ORG_ID, 
              ORGRANK_NAME AREA 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORGRANK like (
                select 
                  case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
                from 
                  DM_CODE.CODE_ORG 
                where 
                  ORG_ID = '188'
              )
          ) org 
          left join HR_DM.HR_DM_EMPLOYEE_KPI_MON t on org.ORG_ID = t.SALE_NO 
          left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on t.EMP_CODE = hr.EMP_CODE 
          left join DM_CODE.CODE_KPI_CODE code on t.KPI_CODE = code.KPI_CODE 
        where 
          t.MONTH_ID = '201910' 
          and hr.ZG_GW = '101' 
          and hr.EMP_TYPE = '0' 
          and hr.LINE_TYPE = '1' 
        group by 
          t.EMP_CODE
      ) t1
  ) kpi on info.EMP_CODE = kpi.EMP_CODE 
where 
  info.MONTH_ID = '201910' 
  and info.ZG_GW = '101' 
  and info.EMP_TYPE = '0' 
  and info.LINE_TYPE = '1' 
order by 
  CAP


三透视总览-岗位信息数据
select 
  month.MONTH, 
  nvl(temp.VAL1, 0) VAL1, 
  nvl(temp.VAL2, 0) VAL2, 
  nvl(temp.VAL3, 0) VAL3, 
  round(
    case when nvl(temp.VAL1, 0)= 0 then 0 else nvl(temp.VAL2, 0)* 100 / temp.VAL1 end, 
    2
  ) VAL4, 
  round(
    case when nvl(temp.VAL1, 0)= 0 then 0 else nvl(temp.VAL3, 0)* 100 / temp.VAL1 end, 
    2
  ) VAL5 
from 
  (
    select 
      to_char(
        add_months(
          to_date('201910', 'yyyymm'), 
          1 - rownum
        ), 
        'yyyymm'
      ) MONTH 
    from 
      dual connect by rownum <= 13
  ) month 
  left join (
    select 
      hr.MONTH_ID MONTH, 
      nvl(
        count(hr.MONTH_ID), 
        0
      ) VAL1, 
      nvl(
        count(hr.ZG_GW), 
        0
      ) VAL2, 
      nvl(
        count(
          case when (
            hr.ZC_GW = hr.ZG_GW 
            and hr.ZG_GW is not null
          ) then 1 else null end
        ), 
        0
      ) VAL3 
    from 
      hr_dm.HR_DM_EMPLOYEE_INFO_MON hr 
    where 
      hr.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.AREA_NO = '188' 
      and hr.ZC_GW = '101' 
      and hr.LINE_TYPE = '1' 
    group by 
      hr.MONTH_ID
  ) temp on month.MONTH = temp.MONTH 
order by 
  month.MONTH
三透视总览-活跃度
select 
  month.MONTH, 
  nvl(temp.VAL, 0) VAL 
from 
  (
    select 
      to_char(
        add_months(
          to_date('201910', 'yyyymm'), 
          1 - rownum
        ), 
        'yyyymm'
      ) MONTH 
    from 
      dual connect by rownum <= 13
  ) month 
  left join (
    select 
      hr.MONTH_ID MONTH, 
      round(
        nvl(hr.ACTIVE_RATE * 100, 0), 
        2
      ) VAL 
    from 
      hr_dm.HR_DM_PST_ACTIVE_MON hr 
    where 
      hr.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.ORG_ID = '188' 
      and hr.ZG_GW = '101' 
      and hr.LINE_TYPE = '1'
  ) temp on month.MONTH = temp.MONTH 
order by 
  month.MONTH
月透视-平均产能
select 
  month.MONTH NAME, 
  nvl(temp.VAL, 0) VAL 
from 
  (
    SELECT 
      TO_CHAR(
        ADD_MONTHS(
          TO_DATE('201910', 'yyyyMM'), 
          - ROWNUM + 1
        ), 
        'yyyyMM'
      ) MONTH 
    FROM 
      dual CONNECT BY ROWNUM <= 12
  ) month 
  left join (
    select 
      hr.MONTH_ID, 
      round(
        avg(
          nvl(hr.CAP, 0)
        ), 
        2
      ) VAL 
    from 
      (
        select 
          ORG_ID, 
          ORGRANK_NAME AREA 
        from 
          DM_CODE.CODE_ORG 
        where 
          ORGRANK like (
            select 
              case when ORGRANK is null then '' else ORGRANK || '%' end PREFIX 
            from 
              DM_CODE.CODE_ORG 
            where 
              ORG_ID = '188'
          )
      ) org 
      left join HR_DM.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.SALE_NO 
    where 
      hr.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.ZG_GW = '101' 
      and hr.LINE_TYPE = '1' 
    group by 
      hr.MONTH_ID
  ) temp on month.MONTH = temp.MONTH_ID 
order by 
  NAME
三透视总览-低产能分析
select 
  month.MONTH NAME, 
  nvl(temp.VAL1, 0) VAL1, 
  case when (
    temp.VAL2 = 0 
    or temp.VAL2 is null
  ) then 0 else round(VAL1 * 100 / VAL2, 2) end VAL2 
from 
  (
    select 
      to_char(
        add_months(
          to_date('201910', 'yyyymm'), 
          1 - rownum
        ), 
        'yyyymm'
      ) MONTH 
    from 
      dual connect by rownum <= 13
  ) month 
  left join (
    select 
      hr.MONTH_ID, 
      nvl(
        count(
          case when hr.IS_LOW = '1' then 1 else null end
        ), 
        0
      ) VAL1, 
      nvl(
        count(1), 
        0
      ) VAL2 
    from 
      HR_DM.HR_DM_EMPLOYEE_INFO_MON hr 
    where 
      hr.MONTH_ID between to_char(
        add_months(
          TO_date('201910', 'yyyyMM'), 
          -12
        ), 
        'yyyyMM'
      ) 
      and '201910' 
      and hr.AREA_NO = '188' 
      and hr.ZC_GW = '101' 
      and hr.LINE_TYPE = '1' 
    group by 
      hr.MONTH_ID
  ) temp on month.MONTH = temp.MONTH_ID 
order by 
  month.MONTH
三透视总览-岗位信息图
select 
  code.GW_CODE, 
  code.GW_NAME, 
  code.LINE_CODE, 
  code.LINE_NAME, 
  nvl(VAL1, 0)|| '' VAL1, 
  nvl(VAL2, 0)|| '' VAL2, 
  case when code.LINE_CODE = 1 then 'marketLine' when code.LINE_CODE = 2 then 'governmentBusinessLine' when code.LINE_CODE = 3 then 'networkLine' else 'supportLine' end INFO 
from 
  dm_code.code_gw code 
  left join (
    select 
      ZG_GW, 
      count(1) VAL1, 
      sum(
        nvl(hr.CAP, 0)
      ) VAL2 
    from 
      hr_dm.HR_DM_EMPLOYEE_INFO_MON hr 
    where 
      MONTH_ID = '201910' 
      and hr.AREA_NO = '188' 
    group by 
      ZG_GW
  ) temp on code.GW_CODE = temp.ZG_GW 
order by 
  code.LINE_CODE, 
  code.GW_IDX
三透视总览-效能矩阵
select 
  org.NAME, 
  substr(org.NAME, 1, 1) NAME1, 
  nvl(temp.VAL1, 0)|| '' VAL1, 
  round(
    avg(
      nvl(temp.VAL1, 0)
    ) over(), 
    2
  )|| '' AVGX, 
  nvl(temp.VAL2, 0)|| '' VAL2, 
  round(
    avg(
      nvl(temp.VAL2, 0)
    ) over(), 
    2
  )|| '' AVGY 
from 
  (
    select 
      NAME 
    from 
      dm_code.code_org 
    where 
      PARENT_ID = '188'
  ) org 
  left join(
    select 
      org.NAME, 
      round(
        avg(
          nvl(hr.CAP, 0)
        ), 
        2
      ) VAL1, 
      round(
        avg(
          nvl(hr.JX_FEE, 0)
        ), 
        2
      ) VAL2 
    from 
      dm_code.code_org org 
      left join hr_dm.HR_DM_EMPLOYEE_INFO_MON hr on org.ORG_ID = hr.CITY_NO 
    where 
      org.PARENT_ID = '188' 
      and hr.MONTH_ID = '201910' 
      and hr.ZG_GW = '101' 
      and hr.LINE_TYPE = '1' 
    group by 
      org.NAME
  ) temp on org.NAME = temp.NAME
